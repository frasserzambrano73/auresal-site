<!doctype html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visor Aurea 2025 ‚Äì Urbanismo y Licencias (Decreto 1077)</title>
  <meta name="description" content="Visor geoespacial especializado en licencias urban√≠sticas seg√∫n Decreto 1077 de 2015. Ideal para planeaci√≥n territorial, gesti√≥n ambiental y estudios de riesgo en Colombia." />
  <meta name="theme-color" content="#0a7bc2" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='%230a7bc2'/><path d='M20 60 L45 35 L60 50 L80 30' stroke='white' stroke-width='8' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>" />
  <!-- Preconexiones -->
  <link rel="preconnect" href="https://a.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://b.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://c.tile.openstreetmap.org" crossorigin>
  <link rel="preconnect" href="https://tiles.maps.eox.at" crossorigin>
  <link rel="preconnect" href="https://firms.modaps.eosdis.nasa.gov" crossorigin>
  <link rel="preconnect" href="https://server.arcgisonline.com" crossorigin>
  <!-- Leaflet + Geoman -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css"/>
  <script defer src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
  <!-- MapLibre GL (3D) -->
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css"/>
  <script defer src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>
  <!-- ‚úÖ Turf.js para an√°lisis geoespacial -->
  <script defer src="https://unpkg.com/@turf/turf@7/turf.min.js"></script>
  <style>
    :root {
      --primary: #0a74d1;
      --secondary: #2fb36f;
      --accent: #f4b400;
      --bg: #ffffff;
      --card: #f7fafc;
      --border: #e2e8f0;
      --text: #1f2937;
      --muted: #64748b;
      --shadow: 0 6px 16px rgba(2,6,23,.06);
      --radius: 16px;
      --radius-lg: 20px;
      --headerH: 64px;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    .promo-banner {
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      color: white;
      text-align: center;
      padding: 10px;
      font-weight: bold;
      font-size: 0.95rem;
      z-index: 999;
    }
    .promo-banner a {
      color: white;
      text-decoration: underline;
      margin-left: 8px;
    }
    header {
      position: sticky;
      top: 0;
      z-index: 5000;
      background: rgba(255,255,255,0.95);
      backdrop-filter: none;
      border-bottom: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    .wrap {
      max-width: 1400px;
      margin: auto;
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 20px;
    }
    .logo-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .logo-container img {
      height: 32px;
      border-radius: 8px;
      box-shadow: var(--shadow);
      cursor: pointer;
      transition: transform 0.2s;
    }
    .logo-container img:hover { transform: scale(1.05); }
    nav.top-menu {
      display: flex;
      gap: 16px;
      align-items: center;
      font-weight: 600;
      margin-left: auto;
    }
    nav.top-menu a,
    .dropdown-btn {
      text-decoration: none;
      color: var(--text);
      padding: 8px 12px;
      border-radius: 6px;
      transition: background-color 0.2s;
    }
    nav.top-menu a:hover,
    .dropdown-btn:hover {
      background-color: var(--primary);
      color: white;
    }
    .dropdown-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    .dropdown-content {
      display: none;
      position: absolute;
      background-color: var(--card);
      min-width: 220px;
      box-shadow: var(--shadow);
      border: 1px solid var(--border);
      border-top: none;
      z-index: 1001;
      border-radius: 0 0 6px 6px;
    }
    .dropdown-content a {
      color: var(--text);
      padding: 10px 20px;
      text-decoration: none;
      display: block;
      transition: background-color 0.2s;
    }
    .dropdown-content a:hover {
      background-color: var(--primary);
      color: white;
    }
    .dropdown.active .dropdown-content { display: block; }
    #shell {
      position: relative;
      height: calc(100vh - 64px - 40px);
    }
    #map, #map3d {
      position: absolute;
      inset: 0;
      border-radius: 14px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
    }
    #map3d { display: none; }
    .toolbar {
      position: absolute;
      top: 16px;
      right: 16px;
      z-index: 1001;
      display: flex;
      flex-direction: column;
      gap: 10px;
      background: rgba(255,255,255,0.92);
      backdrop-filter: none;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      min-width: 180px;
    }
    .toolbar .row { display: flex; gap: 8px; }
    .btn {
      border: none;
      background: rgba(255, 255, 255, 0.85);
      color: var(--text);
      border-radius: 20px;
      padding: 8px 16px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.25s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
      backdrop-filter: blur(4px);
    }
    .btn:hover {
      background: rgba(10, 123, 194, 0.12);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.12);
    }
    .btn.active, .btn.primary {
      background: var(--primary);
      color: white;
      box-shadow: 0 4px 10px rgba(10, 123, 194, 0.3);
    }
    .btn.primary:hover {
      background: #096aa5;
      transform: translateY(-2px);
    }
    .input {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      width: 100%;
    }
    .drawer {
      position: absolute;
      top: 0;
      left: 0;
      width: 360px;
      height: 100%;
      background: var(--card);
      border-right: 1px solid var(--border);
      transform: translateX(-100%);
      transition: transform .35s ease;
      z-index: 1002;
      display: flex;
      flex-direction: column;
    }
    .drawer.open { transform: translateX(0); }
    .drawer .head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.8);
    }
    .drawer .content { padding: 16px; overflow: auto; }
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
      border-bottom: 1px solid var(--border);
      padding-bottom: 8px;
    }
    .tab {
      padding: 8px 12px;
      border-radius: 8px 8px 0 0;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
    }
    .tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--border);
    }
    .panel { display: none; }
    .panel.active {
      display: block;
      animation: fadeIn .25s ease;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    .layer-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin: 10px 0;
      background: rgba(26,35,53,.03);
      padding: 10px;
      border-radius: 10px;
      font-size: 0.92rem;
    }
    .layer-label {
      flex: 1;
      text-align: left;
    }
    .elegant-toggle {
      position: relative;
      display: inline-block;
      width: 48px;
      height: 24px;
    }
    .elegant-toggle input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .elegant-toggle .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #d1d5db;
      transition: .3s;
      border-radius: 12px;
    }
    .elegant-toggle .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }
    .elegant-toggle input:checked + .slider {
      background-color: var(--primary);
    }
    .elegant-toggle input:checked + .slider:before {
      transform: translateX(24px);
    }
    .layer-opacity {
      width: 80px;
      height: 4px;
      -webkit-appearance: none;
      background: #e5e7eb;
      border-radius: 2px;
      outline: none;
    }
    .layer-opacity::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--primary);
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.25);
    }
    .coord {
      font-size: .9rem;
      color: var(--muted);
      margin-top: 10px;
      padding: 10px;
      background: rgba(26,35,53,.05);
      border-radius: 10px;
    }
    .legend {
      font-size: .9rem;
      color: var(--muted);
      display: grid;
      gap: 4px;
    }
    .legend .k {
      display: inline-block;
      width: 10px;
      height: 10px;
      border-radius: 2px;
      margin-right: 6px;
      vertical-align: middle;
    }
    .hud {
      position: absolute;
      left: 16px;
      bottom: 16px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      font-size: 12px;
    }
    .loading {
      position: absolute;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.45);
      backdrop-filter: blur(2px);
      border-radius: 14px;
      z-index: 5000;
      opacity: 0;
      pointer-events: none;
      transition: opacity .2s;
    }
    .loading.active {
      opacity: 1;
      pointer-events: auto;
    }
    .trackball {
      position: absolute;
      right: 16px;
      bottom: 16px;
      z-index: 1002;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px;
      text-align: center;
      display: none;
    }
    #tb {
      width: 160px;
      height: 160px;
      display: block;
      border-radius: 50%;
      background: radial-gradient(circle at 35% 35%, #eaf2ff, #c6d8ff 60%, #b8c8e6 80%, #a6b6d4 100%);
      box-shadow: inset -8px -10px 18px rgba(0,0,0,.15), inset 10px 12px 20px rgba(255,255,255,.55);
      cursor: grab;
    }
    #tb:active { cursor: grabbing; }
    .tb-row {
      display: flex;
      gap: 6px;
      margin-top: 6px;
    }
    .user-location-icon {
      border: none;
      background: none;
    }
    /* ‚úÖ MEN√ö CONTEXTUAL */
    .context-menu {
      position: absolute;
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 2000;
      padding: 6px 0;
      font-size: 0.9rem;
      min-width: 180px;
    }
    .ctx-item {
      display: block;
      width: 100%;
      text-align: left;
      padding: 8px 14px;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text);
    }
    .ctx-item:hover {
      background: var(--primary);
      color: white;
    }
    .ctx-separator {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }
    @media (max-width: 760px) {
      .trackball { display: none !important; }
      .wrap { flex-wrap: wrap; }
      nav.top-menu { margin-left: 0; margin-top: 10px; }
      .promo-banner { font-size: 0.85rem; padding: 8px; }
    }
    .dropzone {
      margin-top: 8px;
      border: 2px dashed #cbd5e1;
      background: rgba(26,35,53,.03);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      color: var(--muted);
      transition: .2s;
    }
    .dropzone.dragover { border-color: var(--primary); background: rgba(10,123,194,.08); color: var(--primary); }
    .gj-list { display: grid; gap: 8px; margin-top: 12px; }
    .gj-item {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: center;
      padding: 10px;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }
    .gj-item .title { font-weight: 600; font-size: .95rem; }
    .gj-controls { display: flex; gap: 6px; flex-wrap: wrap; justify-content: flex-end; }
    .mini {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer;
    }
    .mini:hover { background: rgba(10,123,194,.08); border-color: var(--primary); color: var(--primary); }
    input[type="color"].mini { padding: 0; width: 36px; height: 28px; }
    .range-mini {
      width: 90px;
      height: 4px;
      -webkit-appearance: none;
      background: #e5e7eb;
      border-radius: 2px;
      outline: none;
      margin: 0 4px;
    }
    .range-mini::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 2px 4px rgba(0,0,0,.25);
    }
    .badge {
      display: inline-block;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #f8fafc;
      color: #475569;
    }
  
@media (prefers-reduced-motion: reduce) {
  * { animation: none !important; transition: none !important; scroll-behavior: auto !important; }
}
.btn { transition: background-color .15s ease, color .15s ease, transform .15s ease, box-shadow .15s ease; }
.btn { border-radius: 999px; padding: 10px 16px; font-weight: 700; border: 1px solid transparent; }
.btn:focus-visible, .input:focus-visible { outline: 3px solid rgba(10,116,209,.25); outline-offset: 2px; }
.input { border: 1px solid var(--border); background: #fff; border-radius: 12px; }
.promo-banner { background: linear-gradient(90deg, var(--primary), var(--secondary)); }
.layer-item { border: 1px solid var(--border); background: #fff; border-radius: 12px; }
.elegant-toggle input:checked + .slider { background: linear-gradient(90deg, var(--primary), var(--secondary)); }
nav.top-menu a, .dropdown-btn { border-radius: 10px; }
.dropdown-content { margin-top: 8px; border-top-left-radius: 10px; border-top-right-radius: 10px; }
#map, #map3d, .toolbar { border-radius: var(--radius-lg); }
.hud, .drawer, .trackball, .coord { border-radius: var(--radius); }
@media (max-width: 760px) { #map, #map3d, .toolbar { box-shadow: none; } }


.pl-card { border:1px solid var(--border); border-radius:12px; background:#fff; padding:10px 12px; transition: box-shadow .15s ease, transform .15s ease; cursor:pointer; }
.pl-card:hover { box-shadow: 0 6px 16px rgba(2,6,23,.06); transform: translateY(-1px); }
.pl-card .title { font-weight:600; display:flex; align-items:center; gap:8px; }
.pl-badge { display:inline-block; font-size:11px; padding:2px 8px; border-radius:999px; background:#f1f5f9; border:1px solid var(--border); color:#334155; }

</style>
</head>
<body>
  <div class="promo-banner">
    üèóÔ∏è Visor de la Fundaci√≥n Urbanismo y Territorio
    <a href="tienda.html">Ver servicios</a> ‚Ä¢
    <a href="donar.html">Apoya nuestro trabajo</a>
  </div>
  <header>
    <div class="wrap">
      <div class="logo-container">
  <button id="open-drawer" class="main-brand-btn" title="Abrir panel de control">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
      <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
    </svg>
    <span class="brand-text">
      <span class="visor-name">√çndice</span>
    </span>
  </button>
   </div>
      <nav class="top-menu">
        <button id="btn-nosotros" class="dropdown-btn">Nosotros</button>
        <div class="dropdown" id="urbanismo-dropdown">
          <button class="dropdown-btn">Urbanismo</button>
          <div class="dropdown-content">
            <a href="#">Licencias D. 1077/2015</a>
          </div>
        </div>
        <div class="dropdown" id="planes-dropdown">
          <button class="dropdown-btn">Planes</button>
          <div class="dropdown-content">
            <a href="#">G√ºic√°n</a>
            <a href="#">El Cocuy</a>
            <a href="#">Guacamayas</a>
            <a href="#">Ventaquemada</a>
          </div>
        </div>
        <button id="btn-licencias" class="dropdown-btn" style="background: var(--accent); color: black; font-weight: 700;">Licencias</button>
        <a href="tienda.html" style="background: var(--accent); color: black; font-weight: bold;">Tienda</a>
        <a href="donar.html" style="background: #e74c3c; color: white; font-weight: bold;">Donar</a>
      </nav>
    </div>
  </header>
  <main id="visor">
    <div id="shell">
      <div id="map" aria-label="Mapa 2D"></div>
      <div id="map3d" aria-label="Mapa 3D"></div>
      <div class="loading" id="loading">Cargando‚Ä¶</div>
      <div class="toolbar">
        <div class="row">
          <button id="btn2d" class="btn active">2D</button>
          <button id="btn3d" class="btn">3D</button>
        </div>
        <button id="btn-draw" class="btn" title="Dibujar/editar">‚úèÔ∏è Dibujar</button>
        <button id="btn-measure" class="btn" title="Medir">üìè Medir</button>
        <button id="btn-locate" class="btn" title="Obtener mi ubicaci√≥n actual">üìç Mi ubicaci√≥n</button>
        <button id="btn-reset" class="btn" title="Restablecer">üîÑ Reset</button>
        <button id="share-link" class="btn primary" title="Copiar enlace">üîó Compartir</button>
        <input id="search-input" class="input" placeholder="üîç Buscar (Enter)" />
      </div>
      <div class="hud" id="hud">üó∫Ô∏è 2D ‚Äî lat: ‚Äì, lng: ‚Äì, z: ‚Äì</div>
      <aside class="drawer" id="drawer">
        <div class="head">
          <strong>Panel</strong>
          <button class="btn" id="close-drawer">‚úñ</button>
        </div>
        <div class="content">
          <div class="tabs">
            <button class="tab active" data-tab="capas">Capas</button>
            <button class="tab" data-tab="leyenda">Leyenda</button>
            <button class="tab" data-tab="buscar">Buscar</button>
            <button class="tab" data-tab="capas-locales">Capas locales</button>
            <button class="tab" data-tab="geojson">GeoJSON</button>
          </div>
          <div class="panel active" id="panel-capas">
            <label>Mapa base (2D)</label>
            <div class="toggle"><input type="radio" name="basemap" value="osm" checked id="bm-osm"><label for="bm-osm">üåç OpenStreetMap</label></div>
            <div class="toggle"><input type="radio" name="basemap" value="hot" id="bm-hot"><label for="bm-hot">‚õëÔ∏è OSM Humanitario</label></div>
            <div class="toggle"><input type="radio" name="basemap" value="opentopo" id="bm-opentopo"><label for="bm-opentopo">‚õ∞Ô∏è OpenTopoMap</label></div>
            <div class="toggle"><input type="radio" name="basemap" value="sentinel2" id="bm-sentinel2"><label for="bm-sentinel2">üõ∞Ô∏è Sentinel-2 2024</label></div>
            <div class="toggle"><input type="radio" name="basemap" value="esri" id="bm-esri"><label for="bm-esri">üõ∞Ô∏è Esri World Imagery</label></div>
            <div class="toggle"><input type="radio" name="basemap" value="none" id="bm-none"><label for="bm-none">‚ûñ Sin base</label></div>
            <label style="margin-top:10px">Overlays (WMS)</label>
            <div class="toggle">
              <input type="checkbox" id="ovl-worldcover">
              <label for="ovl-worldcover">üåê ESA WorldCover 2021</label>
            </div>
            <div class="toggle">
              <input type="checkbox" id="ovl-firms">
              <label for="ovl-firms">üî• NASA FIRMS 24h</label>
            </div>
            <div class="coord" id="coord">Lat: ‚Äì, Lon: ‚Äì<br><small style="color:var(--muted);">Sin ubicaci√≥n</small></div>
            <button id="copy-coords" class="btn" style="margin-top:6px; width:100%; font-size:0.85rem;">üìã Copiar coordenadas</button>
          </div>
          <div class="panel" id="panel-leyenda">
            <div class="legend">
              <div><span class="k" style="background:#2ecc71"></span>√Åreas verdes</div>
              <div><span class="k" style="background:#f1c40f"></span>Zonas de intervenci√≥n</div>
              <strong style="margin-top:8px">ESA WorldCover</strong>
              <div><span class="k" style="background:#27ae60"></span>Bosque</div>
              <div><span class="k" style="background:#8d6e63"></span>Suelo desnudo</div>
              <div><span class="k" style="background:#2980b9"></span>Agua</div>
              <strong style="margin-top:8px">NASA FIRMS</strong>
              <div><span class="k" style="background:#e74c3c"></span>Incendios (24h)</div>
              <div><span class="k" style="background:#e67e22"></span>Incendios (48h)</div>
            </div>
          </div>
          <div class="panel" id="panel-buscar">
            <label>üîç Buscar ubicaci√≥n</label>
            <input type="text" id="search-input-panel" class="input" placeholder="Ej: Tunja, Duitama, Sogamoso"/>
            <div class="coord small" id="share-help">Presione Enter para buscar ¬∑ Usa Nominatim</div>
            <div style="margin-top:12px">
              <label>üîó Compartir vista actual</label>
              <button class="btn" id="share-link-panel" style="width:100%">üìã Copiar enlace</button>
              <div id="share-status" class="small" style="margin-top:8px;text-align:center;"></div>
            </div>
          </div>
          <div class="panel" id="panel-capas-locales">
            <p>Selecciona un municipio desde el men√∫ "Planes" para cargar sus capas.</p>
            <div id="capas-locales-contenido"></div>
          </div>
          <div class="panel" id="panel-geojson">
            <label class="btn" for="file-geojson" style="width:100%; text-align:center;">üìÇ Cargar GeoJSON</label>
            <input id="file-geojson" type="file" accept=".geojson,.json" multiple hidden>
            <div id="dz-geojson" class="dropzone">Arrastra y suelta aqu√≠ tus archivos <strong>.geojson</strong> o <strong>.json</strong></div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:10px;">
              <span class="badge">Capas cargadas</span>
              <button id="export-all-geojson" class="mini" title="Exportar todas las capas como un solo GeoJSON">‚¨áÔ∏è Exportar todo</button>
              <button id="clear-all-geojson" class="mini" title="Quitar todas las capas del mapa">üóëÔ∏è Quitar todo</button>
            </div>
            <div id="geojson-list" class="gj-list"></div>
            <small style="color:var(--muted); display:block; margin-top:8px;">
              Consejo: puedes <b>editar geometr√≠as</b> activando ‚Äú‚úèÔ∏è Editar‚Äù en cada capa. Los cambios se exportan tal como los edites.
            </small>
          </div>
        </div>
      </aside>
      <div class="trackball" id="tbbox" aria-label="Control de rotaci√≥n 3D">
        <canvas id="tb" width="160" height="160" title="Arrastra para rotar 360¬∞"></canvas>
        <div class="tb-row">
          <button id="tb-north" class="btn">Norte ‚Üë</button>
          <button id="tb-reset" class="btn">Reset</button>
        </div>
      </div>
    </div>
  </main>
  <div id="modal-nosotros" style="display:none; position:fixed; top:var(--headerH); left:0; width:100%; height:calc(100% - var(--headerH)); background:rgba(0,0,0,0.6); z-index:2000; justify-content:center; align-items:center;">
    <div style="background:white; padding:24px; border-radius:12px; max-width:600px; width:90%; box-shadow:0 8px 24px rgba(0,0,0,0.3); position:relative;">
      <h2 style="margin-top:0; color:#0a7bc2;">Nosotros</h2>
      <p style="line-height:1.6; color:#333;">
        Fundaci√≥n Agua y Urbanismo ‚Äì AUR ESAL es una entidad sin √°nimo de lucro con sede en Colombia, creada para promover el desarrollo de ciudades y territorios sostenibles, resilientes y justos.
      </p>
      <p>
        Ofrecemos servicios especializados en formulaci√≥n de POT/EOT, estudios de riesgo, an√°lisis geoespacial y visualizaci√≥n 3D para municipios del altiplano cundiboyacense.
      </p>
      <div style="margin-top:16px;">
        <a href="tienda.html" style="display:inline-block; background:#0a7bc2; color:white; padding:8px 16px; text-decoration:none; border-radius:6px; margin-right:10px;">Ver servicios</a>
        <a href="donar.html" style="display:inline-block; background:#e74c3c; color:white; padding:8px 16px; text-decoration:none; border-radius:6px;">Donar</a>
      </div>
      <button id="cerrar-modal" style="background:#6c757d; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; margin-top:16px;">
        Cerrar
      </button>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const $ = (s, ctx = document) => ctx.querySelector(s);
      const $$ = (s, ctx = document) => Array.from(ctx.querySelectorAll(s));
      const loading = $('#loading'), hud = $('#hud'), coordEl = $('#coord');

      // === FUNCIONES DE ESTAD√çSTICAS (popup en lugar de panel) ===
      function calcularYMostrarEstadisticas(features, nombreCapa) {
        if (!features || !Array.isArray(features) || features.length === 0) {
          alert('‚ö†Ô∏è Capa sin geometr√≠as v√°lidas.');
          return;
        }
        let areaTotal = 0;
        let conteo = features.length;
        features.forEach(f => {
          if (f.geometry && (f.geometry.type === 'Polygon' || f.geometry.type === 'MultiPolygon')) {
            try {
              areaTotal += turf.area(f);
            } catch (e) {
              console.warn('Geometr√≠a inv√°lida:', f);
            }
          }
        });
        const area_km2 = (areaTotal / 1e6).toFixed(2);
        const area_ha = (areaTotal / 1e4).toFixed(1);

        let html = `<h4 style="margin:0 0 12px 0; color:#0a7bc2;">${nombreCapa}</h4><ul style="padding-left:20px; margin:0;">`;
        if (area_km2 > 0) {
          html += `<li>√Årea total: <strong>${area_km2} km¬≤</strong> (${area_ha} ha)</li>`;
        }
        html += `<li>Elementos: <strong>${conteo}</strong></li></ul>`;

        // Mostrar en popup elegante
        const popup = L.popup({ maxWidth: 300, className: 'stats-popup' })
          .setLatLng(map.getCenter())
          .setContent(html)
          .openOn(map);
      }

      // === FUNCIONES DE EXPORTACI√ìN ===
      function downloadJSON(obj, filename='capa.geojson') {
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type:'application/geo+json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename; a.click();
        URL.revokeObjectURL(url);
      }

      function exportarCSV(features, nombre) {
        if (!features.length) return alert('No hay datos para exportar.');
        const props = features[0].properties || {};
        const headers = Object.keys(props);
        let csv = headers.join(',') + '\n';
        features.forEach(f => {
          const row = headers.map(k => `"${(f.properties?.[k] ?? '').toString().replace(/"/g, '""')}"`).join(',');
          csv += row + '\n';
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${nombre}.csv`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function geojsonToKML(gj) {
        const kml = ['<?xml version="1.0" encoding="UTF-8"?>',
          '<kml xmlns="http://www.opengis.net/kml/2.2">',
          '<Document>'];
        gj.features.forEach(f => {
          const name = f.properties?.name || '';
          const geomJson = JSON.stringify(f.geometry).replace(/"type":"([^"]+)"/g, '"$1"');
          kml.push(`<Placemark><name>${name}</name><Geometry>${geomJson}</Geometry></Placemark>`);
        });
        kml.push('</Document></kml>');
        return kml.join('\n');
      }

      function exportarKML(features, nombre) {
        const kmlStr = geojsonToKML({ type: 'FeatureCollection', features });
        const blob = new Blob([kmlStr], { type: 'application/vnd.google-earth.kml+xml' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `${nombre}.kml`;
        a.click();
        URL.revokeObjectURL(a.href);
      }

      function aplicarFiltro(features, nombre, capaId) {
        const props = features[0]?.properties || {};
        const keys = Object.keys(props);
        if (!keys.length) return alert('No hay atributos para filtrar.');
        const campo = prompt(`Atributos disponibles:\n${keys.join(', ')}\n\nIngresa el nombre del campo a filtrar:`);
        if (!campo || !keys.includes(campo)) return;
        const valor = prompt(`Ingresa el valor exacto a buscar en "${campo}":`);
        if (valor === null) return;
        const filtrados = features.filter(f => 
          f.properties?.[campo]?.toString().toLowerCase() === valor.toString().toLowerCase()
        );
        if (filtrados.length === 0) {
          alert('Ning√∫n elemento coincide con el filtro.');
          return;
        }
        addGeoJSONToMap(`${nombre} - Filtro: ${campo}=${valor}`, { type: 'FeatureCollection', features: filtrados });
      }

      // === MEN√ö CONTEXTUAL MEJORADO ===
      function crearMenuContextual(menuBtn, capaId, features, nombre) {
        let menuEl = null;
        menuBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          document.querySelectorAll('.context-menu').forEach(el => el.remove());
          menuEl = document.createElement('div');
          menuEl.className = 'context-menu';
          menuEl.innerHTML = `
            <button class="ctx-item" data-action="zoom">üîç Acercar a capa</button>
            <button class="ctx-item" data-action="stats">üìä Calcular estad√≠sticas</button>
            <div class="ctx-separator"></div>
            <div style="padding:4px 10px; font-weight:bold; color:var(--muted);">Exportar como:</div>
            <button class="ctx-item" data-action="geojson">GeoJSON (.geojson)</button>
            <button class="ctx-item" data-action="csv">CSV (.csv)</button>
            <button class="ctx-item" data-action="kml">KML (.kml)</button>
            <a href="https://mygeodata.cloud/converter/geojson-to-shp" target="_blank" class="ctx-item" style="text-decoration:none; color:inherit;">Shapefile (online)</a>
            <div class="ctx-separator"></div>
            <button class="ctx-item" data-action="locate">üìç Definir ubicaci√≥n</button>
            <button class="ctx-item" data-action="filter">üß© Filtrar atributos</button>
          `;
          document.body.appendChild(menuEl);
          const rect = menuBtn.getBoundingClientRect();
          
          const vw = window.innerWidth, vh = window.innerHeight;
          const headerH = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--headerH')) || 64;
          let left = rect.right + 4;
          let top = rect.top;
          const menuRect = { w: 240, h: 300 };
          if (left + menuRect.w > vw - 8) left = Math.max(8, rect.left - menuRect.w - 4);
          if (top + menuRect.h > vh - 8) top = Math.max(headerH + 8, vh - menuRect.h - 8);
          if (top < headerH + 8) top = headerH + 8;
          menuEl.style.left = `${left}px`;
          menuEl.style.top = `${top}px`;
    
          setTimeout(() => {
            document.addEventListener('click', cerrarMenu);
          }, 100);
          function cerrarMenu() {
            menuEl?.remove();
            document.removeEventListener('click', cerrarMenu);
          }
          menuEl.querySelectorAll('.ctx-item').forEach(item => {
            item.addEventListener('click', (ev) => {
              ev.stopPropagation();
              const action = item.dataset.action;
              cerrarMenu();
              if (action === 'zoom') {
                try {
                  const bounds = turf.bbox({ type: 'FeatureCollection', features });
                  map.fitBounds([[bounds[1], bounds[0]], [bounds[3], bounds[2]]], { padding: [30,30] });
                } catch (e) { alert('No se puede acercar: geometr√≠a inv√°lida.'); }
              }
              else if (action === 'stats') {
                calcularYMostrarEstadisticas(features, nombre);
              }
              else if (action === 'geojson') {
                downloadJSON({ type: 'FeatureCollection', features }, `${nombre}.geojson`);
              }
              else if (action === 'csv') {
                exportarCSV(features, nombre);
              }
              else if (action === 'kml') {
                exportarKML(features, nombre);
              }
              else if (action === 'locate') {
                const centroid = turf.centroid({ type: 'FeatureCollection', features });
                map.setView([centroid.geometry.coordinates[1], centroid.geometry.coordinates[0]], 14);
              }
              else if (action === 'filter') {
                aplicarFiltro(features, nombre, capaId);
              }
            });
          });
        });
      }

      // === CAPAS REALES DE G√úIC√ÅN ===
      const capasRealesGuican = [
        { nombre: "CG.01. Modelo de ocupaci√≥n del territorio", ruta: "./datos/guican/componente_general/CG.01. Modelo de ocupaci√≥n del territorio.geojson" },
        { nombre: "CG.02. Clasificaci√≥n del suelo", ruta: "./datos/guican/componente_general/CG.02. Clasificaci√≥n del suelo.geojson" },
        { nombre: "CG.03. Suelo de protecci√≥n", ruta: "./datos/guican/componente_general/CG.03. Suelo de protecci√≥n.geojson" },
        { nombre: "CG.04. √Åreas de conservaci√≥n y protecci√≥n ambiental", ruta: "./datos/guican/componente_general/CG.04. √Åreas de conservaci√≥n y protecci√≥n ambiental.geojson" },
        { nombre: "CG.05. Patrimonio Material", ruta: "./datos/guican/componente_general/CG.05. Patrimonio Material.geojson" },
        { nombre: "CG.06. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 23)", ruta: "./datos/guican/componente_general/CG.06. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 23).geojson" },
        { nombre: "CU.01. Suelo urbano y de expansi√≥n urbana", ruta: "./datos/guican/componente_urbano/CU.01. Suelo urbano y de expansi√≥n urbana.geojson" },
        { nombre: "CU.02. √Åreas de conservaci√≥n y protecci√≥n ambiental", ruta: "./datos/guican/componente_urbano/CU.02. √Åreas de conservaci√≥n y protecci√≥n ambiental.geojson" },
        { nombre: "CU.03. Patrimonio material", ruta: "./datos/guican/componente_urbano/CU.03. Patrimonio material.geojson" },
        { nombre: "CU.04. Espacio p√∫blico", ruta: "./datos/guican/componente_urbano/CU.04. Espacio p√∫blico.geojson" },
        { nombre: "CU.05. Servicios p√∫blicos domiciliarios", ruta: "./datos/guican/componente_urbano/CU.05. Servicios p√∫blicos domiciliarios.geojson" },
        { nombre: "CU.06. Equipamientos", ruta: "./datos/guican/componente_urbano/CU.06. Equipamientos.geojson" },
        { nombre: "CU.07. Infraestructura vial y de transporte", ruta: "./datos/guican/componente_urbano/CU.07. Infraestructura vial y de transporte.geojson" },
        { nombre: "CU.08. Tratamientos urban√≠sticos", ruta: "./datos/guican/componente_urbano/CU.08. Tratamientos urban√≠sticos.geojson" },
        { nombre: "CU.09. √Åreas de actividad", ruta: "./datos/guican/componente_urbano/CU.09. √Åreas de actividad.geojson" },
        { nombre: "CU.10. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 24)", ruta: "./datos/guican/componente_urbano/CU.10. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 24).geojson" },
        { nombre: "CR.01. Reglamentaci√≥n del suelo rural", ruta: "./datos/guican/componente_rural/CR.01. Reglamentaci√≥n del suelo rural.geojson" },
        { nombre: "CR.02. √Åreas de conservaci√≥n y protecci√≥n ambiental", ruta: "./datos/guican/componente_rural/CR.02. √Åreas de conservaci√≥n y protecci√≥n ambiental.geojson" },
        { nombre: "CR.03. Categor√≠as del suelo rural", ruta: "./datos/guican/componente_rural/CR.03. Categor√≠as del suelo rural.geojson" },
        { nombre: "CR.04. Centros poblados", ruta: "./datos/guican/componente_rural/CR.04. Centros poblados.geojson" },
        { nombre: "CR.05. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 25)", ruta: "./datos/guican/componente_rural/CR.05. Incorporaci√≥n de la gesti√≥n del riesgo (Art. 25).geojson" }
      ];
      const municipiosNombres = {
        'G√ºic√°n': 'guican',
        'El Cocuy': 'el_cocuy',
        'Guacamayas': 'guacamayas',
        'Ventaquemada': 'ventaquemada'
      };
      const capasLocales = {};
      const capasFeatures = {};

      function toggleCapaPorURL(ruta, nombre, activar, opacidad = 0.7, id) {
        if (activar) {
          fetch(ruta)
            .then(res => res.ok ? res.json() : Promise.reject(`404: ${ruta}`))
            .then(data => {
              const lyr = L.geoJSON(data, {
                style: { color: '#d32f2f', weight: 2, fillColor: '#ff6b6b', fillOpacity: opacidad },
                onEachFeature: (f, l) => {
                  if (f.properties) {
                    let html = '<table style="font-size:0.9em;">';
                    for (let k in f.properties) html += `<tr><td><b>${k}:</b></td><td>${f.properties[k]}</td></tr>`;
                    html += '</table>';
                    l.bindPopup(html);
                  }
                }
              }).addTo(map);
              capasLocales[id] = lyr;
              capasFeatures[id] = data.features;
              const menuBtn = $(`[data-menu="${id}"]`);
              if (menuBtn) crearMenuContextual(menuBtn, id, data.features, nombre);
            })
            .catch(err => {
              console.warn(`Error al cargar: ${ruta}`, err);
              alert(`‚ö†Ô∏è No se pudo cargar la capa:\n"${nombre}"\nVerifica que el archivo exista.`);
              const chk = $(`#${id}`);
              if (chk) chk.checked = false;
            });
        } else {
          if (capasLocales[id]) {
            map.removeLayer(capasLocales[id]);
            delete capasLocales[id];
            delete capasFeatures[id];
          }
        }
      }

      function cargarCapasMunicipio(nombreMostrado) {
        const nombreTecnico = municipiosNombres[nombreMostrado];
        if (!nombreTecnico) return;
        $('#drawer').classList.add('open');
        $$('.tab').forEach(t => t.classList.remove('active'));
        $(`[data-tab="capas-locales"]`).classList.add('active');
        $$('.panel').forEach(p => p.classList.remove('active'));
        $('#panel-capas-locales').classList.add('active');
        const contenedor = $('#capas-locales-contenido');
        contenedor.innerHTML = `<h4 style="margin-bottom:16px;">Capas: ${nombreMostrado}</h4>`;
        if (nombreMostrado === 'G√ºic√°n') {
          // Componente General
          contenedor.innerHTML += `<h5 style="margin:16px 0 10px; color:var(--primary); font-weight:600;">Componente General</h5>`;
          for (let i = 0; i < 6; i++) {
            const capa = capasRealesGuican[i];
            const idCheck = `guican-${i}`;
            const div = document.createElement('div');
            div.className = 'layer-item';
            div.innerHTML = `
              <span class="layer-label">${capa.nombre}</span>
              <div style="display:flex; align-items:center; gap:8px;">
                <label class="elegant-toggle">
                  <input type="checkbox" id="${idCheck}" data-url="${capa.ruta}">
                  <span class="slider"></span>
                </label>
                <input type="range" min="0" max="1" step="0.05" value="0.7" class="layer-opacity" id="${idCheck}-opacity" disabled>
                <button class="mini" data-menu="${idCheck}" title="M√°s opciones">‚ãØ</button>
              </div>
            `;
            contenedor.appendChild(div);
            const chk = $(`#${idCheck}`);
            const range = $(`#${idCheck}-opacity`);
            chk.addEventListener('change', () => {
              range.disabled = !chk.checked;
              toggleCapaPorURL(capa.ruta, capa.nombre, chk.checked, parseFloat(range.value), idCheck);
            });
            range.addEventListener('input', () => {
              if (capasLocales[idCheck]) {
                capasLocales[idCheck].setStyle?.({ fillOpacity: parseFloat(range.value) });
              }
            });
          }
          // Componente Urbano
          contenedor.innerHTML += `<h5 style="margin:20px 0 10px; color:var(--primary); font-weight:600;">Componente Urbano</h5>`;
          for (let i = 6; i < 16; i++) {
            const capa = capasRealesGuican[i];
            const idCheck = `guican-${i}`;
            const div = document.createElement('div');
            div.className = 'layer-item';
            div.innerHTML = `
              <span class="layer-label">${capa.nombre}</span>
              <div style="display:flex; align-items:center; gap:8px;">
                <label class="elegant-toggle">
                  <input type="checkbox" id="${idCheck}" data-url="${capa.ruta}">
                  <span class="slider"></span>
                </label>
                <input type="range" min="0" max="1" step="0.05" value="0.7" class="layer-opacity" id="${idCheck}-opacity" disabled>
                <button class="mini" data-menu="${idCheck}" title="M√°s opciones">‚ãØ</button>
              </div>
            `;
            contenedor.appendChild(div);
            const chk = $(`#${idCheck}`);
            const range = $(`#${idCheck}-opacity`);
            chk.addEventListener('change', () => {
              range.disabled = !chk.checked;
              toggleCapaPorURL(capa.ruta, capa.nombre, chk.checked, parseFloat(range.value), idCheck);
            });
            range.addEventListener('input', () => {
              if (capasLocales[idCheck]) {
                capasLocales[idCheck].setStyle?.({ fillOpacity: parseFloat(range.value) });
              }
            });
          }
          // Componente Rural
          contenedor.innerHTML += `<h5 style="margin:20px 0 10px; color:var(--primary); font-weight:600;">Componente Rural</h5>`;
          for (let i = 16; i < 21; i++) {
            const capa = capasRealesGuican[i];
            const idCheck = `guican-${i}`;
            const div = document.createElement('div');
            div.className = 'layer-item';
            div.innerHTML = `
              <span class="layer-label">${capa.nombre}</span>
              <div style="display:flex; align-items:center; gap:8px;">
                <label class="elegant-toggle">
                  <input type="checkbox" id="${idCheck}" data-url="${capa.ruta}">
                  <span class="slider"></span>
                </label>
                <input type="range" min="0" max="1" step="0.05" value="0.7" class="layer-opacity" id="${idCheck}-opacity" disabled>
                <button class="mini" data-menu="${idCheck}" title="M√°s opciones">‚ãØ</button>
              </div>
            `;
            contenedor.appendChild(div);
            const chk = $(`#${idCheck}`);
            const range = $(`#${idCheck}-opacity`);
            chk.addEventListener('change', () => {
              range.disabled = !chk.checked;
              toggleCapaPorURL(capa.ruta, capa.nombre, chk.checked, parseFloat(range.value), idCheck);
            });
            range.addEventListener('input', () => {
              if (capasLocales[idCheck]) {
                capasLocales[idCheck].setStyle?.({ fillOpacity: parseFloat(range.value) });
              }
            });
          }
        } else {
          contenedor.innerHTML += `<p style="color:var(--muted); margin-top:12px;">Capas pendientes de carga.</p>`;
        }
      }

      // === RESTO DEL C√ìDIGO (MAPA, 3D, DROPDOWNS, ETC.) ===
      
      const dropdowns = $$('.dropdown');
      dropdowns.forEach(d => {
        const btn = d.querySelector('.dropdown-btn');
        btn?.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdowns.forEach(o => { if (o !== d) o.classList.remove('active'); });
          d.classList.toggle('active');
        });
      });
      document.addEventListener('click', () => dropdowns.forEach(d => d.classList.remove('active')));
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') dropdowns.forEach(d => d.classList.remove('active')); });

      // Modal "Nosotros"
      const btnNosotros = $('#btn-nosotros');
      const modalNosotros = $('#modal-nosotros');
      const btnCerrarModal = $('#cerrar-modal');
      if (btnNosotros && modalNosotros && btnCerrarModal) {
        btnNosotros.addEventListener('click', (e) => {
          e.stopPropagation();
          modalNosotros.style.display = 'flex';
        });
        btnCerrarModal.addEventListener('click', () => {
          modalNosotros.style.display = 'none';
        });
        modalNosotros.addEventListener('click', (e) => {
          if (e.target === modalNosotros) modalNosotros.style.display = 'none';
        });
      }
      const map = L.map('map', { preferCanvas: true, zoomControl: false, attributionControl: false, zoomAnimation:false, fadeAnimation:false, markerZoomAnimation:false, updateWhenDragging:false, updateWhenZooming:false });
      const start = [6.467, -72.416];
      map.setView(start, 12);
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      const attrCtrl = L.control.attribution({ prefix: false }).addAttribution('¬© OpenStreetMap contributors');
      attrCtrl.addTo(map);
      const basemaps = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, subdomains: 'abc' }),
        hot: L.tileLayer('https://{s}.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', { maxZoom: 19, subdomains: 'abc' }),
        opentopo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { maxZoom: 17, subdomains: 'abc' }),
        sentinel2: L.tileLayer('https://tiles.maps.eox.at/wmts?layer=s2cloudless-2024&style=default&tilematrixset=WebMercatorQuad&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image%2Fjpeg&TileMatrix={z}&TileCol={x}&TileRow={y}', {
          maxZoom: 18,
          attribution: 'Sentinel-2 Cloudless 2024 ¬© EOX / ESA'
        }),
        esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 19,
          attribution: 'Im√°genes ¬© Esri ‚Äî Fuente: Esri, DigitalGlobe, GeoEye, Earthstar Geographics, CNES/Airbus DS, USDA, USGS, AeroGRID, IGN, y la comunidad de colaboradores de GIS'
        }),
        none: L.tileLayer('', {})
      };
      let currentBase = 'osm';
      basemaps[currentBase].addTo(map);
      const overlays = {
        worldcover: L.tileLayer.wms('https://tiles.maps.eox.at/wms', {
          layers: 'worldcover',
          format: 'image/png',
          transparent: true,
          opacity: 0.55,
          version: '1.3.0'
        }),
        firms: L.tileLayer.wms('https://firms.modaps.eosdis.nasa.gov/mapserver/wms_viirs_suomi', {
          layers: 'fires_viirs_24',
          format: 'image/png',
          transparent: true,
          opacity: 0.75,
          version: '1.3.0'
        })
      };
      // Activa manualmente desde el panel
      // Activa manualmente desde el panel
      attrCtrl.addAttribution('ESA WorldCover 2021 ¬∑ NASA FIRMS (VIIRS)');
      const chkWC = $('#ovl-worldcover');
      const chkF = $('#ovl-firms');
      function syncOverlay(chk, layer) {
        if (chk.checked) {
          if (!map.hasLayer(layer)) layer.addTo(map);
        } else {
          if (map.hasLayer(layer)) map.removeLayer(layer);
        }
      }
      chkWC.addEventListener('change', () => syncOverlay(chkWC, overlays.worldcover));
      chkF.addEventListener('change', () => syncOverlay(chkF, overlays.firms));
      function syncHUD2D() {
        const c = map.getCenter();
        hud.textContent = `üó∫Ô∏è 2D ‚Äî lat: ${c.lat.toFixed(5)}, lng: ${c.lng.toFixed(5)}, z: ${map.getZoom().toFixed(2)}`;
      }
      map.on('move zoom click', syncHUD2D);
      syncHUD2D();
      map.on('mousemove', (e) => coordEl.innerHTML = `Lat: ${e.latlng.lat.toFixed(6)}, Lon: ${e.latlng.lng.toFixed(6)}<br><small style="color:var(--muted);">üñ±Ô∏è Mouse</small>`);
      map.pm.addControls({ position: 'topleft', drawMarker: true, drawPolyline: true, drawPolygon: true, editMode: true, dragMode: true, cutPolygon: true, removalMode: true });
      $('#btn-draw').addEventListener('click', () => map.pm.toggleControls());
      let measuring = false, measureLine = null, pts = [], measureTooltip = null;
      function fmt(m) { return m < 1000 ? `${m.toFixed(1)} m` : `${(m / 1000).toFixed(2)} km`; }
      function stopMeasure() {
        measuring = false;
        if (measureLine) map.removeLayer(measureLine);
        if (measureTooltip) map.removeLayer(measureTooltip);
        map.off('click', onClick);
        map.off('mousemove', onMove);
        map.off('dblclick', onEnd);
        $('#btn-measure').textContent = 'üìè Medir';
        pts = [];
      }
      function onClick(e) {
        pts.push(e.latlng);
        measureLine.setLatLngs(pts);
        if (pts.length > 1) {
          const total = map.distance(pts[0], pts[pts.length - 1]);
          if (!measureTooltip) measureTooltip = L.tooltip({ className: 'custom-tooltip', offset: [0, -20] });
          measureTooltip.setLatLng(e.latlng).setContent(`üìè Distancia: <strong>${fmt(total)}</strong>`).addTo(map);
        }
      }
      function onMove(e) { if (pts.length) measureLine.setLatLngs([...pts, e.latlng]); }
      function onEnd() {
        if (pts.length > 1) {
          const total = map.distance(pts[0], pts[pts.length - 1]);
          alert(`‚úÖ Medici√≥n Finalizada\nDistancia total: ${fmt(total)}`);
        }
        stopMeasure();
      }
      $('#btn-measure').addEventListener('click', () => {
        if (measuring) { stopMeasure(); return; }
        measuring = true;
        measureLine = L.polyline([], { color: '#3b82f6', weight: 4, opacity: .9, dashArray: '5,5' }).addTo(map);
        map.on('click', onClick);
        map.on('mousemove', onMove);
        map.on('dblclick', onEnd);
        $('#btn-measure').textContent = '‚èπÔ∏è Finalizar';
      });
      $$('input[name="basemap"]').forEach(r => r.addEventListener('change', () => {
        Object.values(basemaps).forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
        basemaps[r.value].addTo(map);
        currentBase = r.value;
        if (glmap) change3DBasemap(currentBase);
        updateHash();
      }));
      function showLocation(lat, lng, accuracy) {
        const coordText = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
        const precisionText = `¬±${Math.round(accuracy)} m`;
        let icon, label;
        if (accuracy <= 20) {
          icon = 'üõ∞Ô∏è'; label = 'GPS';
        } else {
          icon = 'üì∂'; label = 'Red';
        }
        hud.textContent = `${icon} ${label} ‚Äî ${coordText} (${precisionText})`;
        coordEl.innerHTML = `
          Lat: ${lat.toFixed(6)}, Lon: ${lng.toFixed(6)}<br>
          <small style="color:var(--muted);">${icon} ${label} ‚Ä¢ ${precisionText}</small>
        `;
        if (window.userLocationMarker) map.removeLayer(window.userLocationMarker);
        const markerIcon = L.divIcon({
          className: 'user-location-icon',
          html: `<div style="
            background: ${accuracy <= 20 ? '#3498db' : '#e67e22'};
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            border: 2px solid white;
          ">${icon}</div>`,
          iconSize: [24, 24],
          iconAnchor: [12, 12]
        });
        window.userLocationMarker = L.marker([lat, lng], { icon: markerIcon })
          .addTo(map)
          .bindPopup(`<b>${icon} Ubicaci√≥n (${label})</b><br>${coordText}<br><small>${precisionText}</small>`)
          .openPopup();
        map.setView([lat, lng], Math.max(map.getZoom(), 15));
      }
      function locateMe() {
        if (!navigator.geolocation) {
          alert('‚ö†Ô∏è Tu navegador no soporta geolocalizaci√≥n.');
          return;
        }
        const btn = $('#btn-locate');
        btn.textContent = 'üìç Buscando‚Ä¶';
        btn.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            const { latitude, longitude, accuracy } = pos.coords;
            showLocation(latitude, longitude, accuracy);
            btn.textContent = 'üìç Mi ubicaci√≥n';
            btn.disabled = false;
          },
          (err) => {
            console.error('Error de geolocalizaci√≥n:', err);
            let msg = '‚ö†Ô∏è No se pudo obtener tu ubicaci√≥n.';
            if (err.code === 1) msg = '‚ö†Ô∏è Permiso de ubicaci√≥n denegado.';
            if (err.code === 2) msg = '‚ö†Ô∏è Ubicaci√≥n no disponible (¬øGPS activado?).';
            if (err.code === 3) msg = '‚ö†Ô∏è Tiempo de espera agotado.';
            alert(msg);
            btn.textContent = 'üìç Mi ubicaci√≥n';
            btn.disabled = false;
          },
          {
            enableHighAccuracy: true,
            timeout: 15000,
            maximumAge: 60000
          }
        );
      }
      $('#btn-locate').addEventListener('click', locateMe);
      $('#copy-coords').addEventListener('click', () => {
        const c = map.getCenter();
        const text = `${c.lat.toFixed(6)},${c.lng.toFixed(6)}`;
        navigator.clipboard.writeText(text).then(() => {
          const btn = $('#copy-coords');
          btn.textContent = '‚úÖ Copiado';
          setTimeout(() => btn.textContent = 'üìã Copiar coordenadas', 1500);
        });
      });
      let lastQueryAt = 0;
      $('#search-input').addEventListener('keydown', async (ev) => {
        if (ev.key !== 'Enter') return;
        const now = Date.now();
        if (now - lastQueryAt < 1200) return;
        lastQueryAt = now;
        const q = ev.target.value.trim();
        if (!q) return;
        try {
          loading.classList.add('active');
          const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
          const res = await fetch(url, { headers: { 'Accept-Language': 'es' } });
          const data = await res.json();
          if (Array.isArray(data) && data.length) {
            const { lat, lon, display_name } = data[0];
            map.flyTo([+lat, +lon], 14, { duration: 1.2 });
            L.marker([+lat, +lon]).addTo(map).bindPopup(`<b>üìç ${display_name}</b>`).openPopup();
          }
        } catch (e) { console.error(e); } finally { loading.classList.remove('active'); }
      });
      $('#search-input-panel').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          $('#search-input').value = e.target.value;
          $('#search-input').dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter' }));
        }
      });
      function updateHash() {
        const c = map.getCenter(), z = map.getZoom();
        const wc = map.hasLayer(overlays.worldcover) ? 1 : 0;
        const ff = map.hasLayer(overlays.firms) ? 1 : 0;
        location.hash = `#2d/${z.toFixed(2)}/${c.lat.toFixed(5)}/${c.lng.toFixed(5)}/${currentBase}/${wc}/${ff}`;
      }
      map.on('moveend', updateHash);
      function copyLink(targetBtn) {
        updateHash();
        navigator.clipboard.writeText(location.href).then(() => {
          targetBtn.textContent = '‚úÖ Copiado';
          setTimeout(() => targetBtn.textContent = targetBtn.id === 'share-link' ? 'üîó Compartir' : 'üìã Copiar enlace', 1500);
          const ss = $('#share-status');
          if (ss) {
            ss.textContent = 'Enlace copiado al portapapeles.';
            setTimeout(() => ss.textContent = '', 1800);
          }
        });
      }
      $('#share-link').addEventListener('click', () => copyLink($('#share-link')));
      $('#share-link-panel').addEventListener('click', () => copyLink($('#share-link-panel')));
      (function restoreFromHash() {
        const h = location.hash.slice(1).split('/');
        if (h.length >= 5) {
          const z = parseFloat(h[1]), lat = parseFloat(h[2]), lon = parseFloat(h[3]), bm = h[4];
          const wcFlag = h[5] !== undefined ? parseInt(h[5], 10) : 1;
          const fFlag = h[6] !== undefined ? parseInt(h[6], 10) : 1;
          if (!isNaN(z) && !isNaN(lat) && !isNaN(lon)) map.setView([lat, lon], z);
          if (basemaps[bm]) {
            Object.values(basemaps).forEach(l => { if (map.hasLayer(l)) map.removeLayer(l); });
            basemaps[bm].addTo(map);
            currentBase = bm;
            const r = $(`input[name="basemap"][value="${bm}"]`);
            if (r) r.checked = true;
          }
          if (wcFlag) {
            // Activa manualmente desde el panel
            $('#ovl-worldcover').checked = true;
          } else {
            if (map.hasLayer(overlays.worldcover)) map.removeLayer(overlays.worldcover);
            $('#ovl-worldcover').checked = false;
          }
          if (fFlag) {
            // Activa manualmente desde el panel
            $('#ovl-firms').checked = true;
          } else {
            if (map.hasLayer(overlays.firms)) map.removeLayer(overlays.firms);
            $('#ovl-firms').checked = false;
          }
        }
      })();
      
      const LICENSES_LITE = [
        { id:"urbanizacion", nombre:"Licencia de Urbanizaci√≥n",
          descripcion:"Autoriza ejecutar obras de urbanizaci√≥n (v√≠as, espacio p√∫blico y redes).",
          modalidades:[{id:"desarrollo",nombre:"Desarrollo"},{id:"saneamiento",nombre:"Saneamiento"},{id:"reurbanizacion",nombre:"Reurbanizaci√≥n"}],
          requisitos:["FUN diligenciado y firmado","Identificaci√≥n del solicitante/representante y poder (si aplica)","Certificado de libertad y tradici√≥n vigente","Acreditaci√≥n de titularidad o autorizaci√≥n","Plano topogr√°fico y propuesta de urbanizaci√≥n","Disponibilidad de servicios p√∫blicos","Memoria justificativa","Estudios t√©cnicos requeridos","Pago de derechos"],
          requisitosPorModalidad:{desarrollo:["Cargas/beneficios; cesiones y etapas"],saneamiento:["Soporte de situaci√≥n a sanear"],reurbanizacion:["Diagn√≥stico urbano y propuesta"]}
        },
        { id:"parcelacion", nombre:"Licencia de Parcelaci√≥n",
          descripcion:"Divide suelo para conformar parcelas en rural/expansi√≥n.",
          modalidades:[],
          requisitos:["FUN diligenciado","Identificaci√≥n/representaci√≥n","Certificado de libertad y tradici√≥n","Plano de parcelaci√≥n georreferenciado","Memoria t√©cnica y urban√≠stica","Viabilidad/disponibilidad de servicios o soluciones","Estudios/permits ambientales (si aplica)","Pago de derechos"]
        },
        { id:"subdivision", nombre:"Licencia de Subdivisi√≥n",
          descripcion:"Divide un predio en varios o ajusta linderos (urbana, rural, reloteo).",
          modalidades:[{id:"urbana",nombre:"Urbana"},{id:"rural",nombre:"Rural"},{id:"reloteo",nombre:"Reloteo"}],
          requisitos:["FUN diligenciado","Identificaci√≥n/representaci√≥n","Certificado de libertad y tradici√≥n","Plano de subdivisi√≥n georreferenciado","Memoria t√©cnica con cumplimiento normativo","Constancias de afectaciones/servidumbres","Pago de derechos"],
          requisitosPorModalidad:{reloteo:["Soporte de acto administrativo o licencia anterior"]}
        },
        { id:"construccion", nombre:"Licencia de Construcci√≥n",
          descripcion:"Obras sobre edificaciones (nueva, ampliaci√≥n, adecuaci√≥n, etc.).",
          modalidades:[{id:"obra-nueva",nombre:"Obra nueva"},{id:"ampliacion",nombre:"Ampliaci√≥n"},{id:"adecuacion",nombre:"Adecuaci√≥n"},{id:"modificacion",nombre:"Modificaci√≥n"},{id:"restauracion",nombre:"Restauraci√≥n"},{id:"reforzamiento",nombre:"Reforzamiento estructural"},{id:"demolicion",nombre:"Demolici√≥n"},{id:"reconstruccion",nombre:"Reconstrucci√≥n"},{id:"cerramiento",nombre:"Cerramiento"}],
          requisitos:["FUN diligenciado","Identificaci√≥n/representaci√≥n y poderes (si aplica)","Certificado de libertad y tradici√≥n","T√≠tulo/autoridad para solicitar","Planos arquitect√≥nicos/urban√≠sticos firmados","Dise√±os/memorias estructurales (NSR)","Estudio de suelos (si aplica)","Licencias/permits complementarios (si aplica)","Conceptos de servicios (si aplica)","Programas de manejo","Pago de derechos"],
          requisitosPorModalidad:{"reforzamiento":["Diagn√≥stico estructural"],"demolicion":["Plan de manejo/disposici√≥n de residuos"],"restauracion":["Autorizaci√≥n de patrimonio (si aplica)"],"cerramiento":["Plano/localizaci√≥n y memoria justificativa"]}
        },
        { id:"espacio-publico", nombre:"Intervenci√≥n y Ocupaci√≥n del Espacio P√∫blico",
          descripcion:"Intervenir u ocupar bienes de uso p√∫blico con marco normativo local.",
          modalidades:[],
          requisitos:["FUN diligenciado","Identificaci√≥n/representaci√≥n","Descripci√≥n t√©cnica y planos","Concepto/permiso entidad administradora","PMT (si aplica)","Seguro/garant√≠as y plan de manejo","Pago de derechos"]
        }
      ];

      function pl_renderList(items) {
        const list = document.getElementById('pl-list');
        list.innerHTML = '';
        items.forEach(it => {
          const div = document.createElement('div');
          div.className = 'pl-card';
          const badges = (it.modalidades||[]).map(m => `<span class="pl-badge">${m.nombre}</span>`).join(' ');
          div.innerHTML = `
            <div class="title">üìÑ ${it.nombre}</div>
            <div style="color:var(--muted); font-size:.92rem; margin-top:4px;">${it.descripcion}</div>
            ${badges ? '<div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">'+badges+'</div>' : ''}
          `;
          div.addEventListener('click', () => pl_openDetail(it.id));
          list.appendChild(div);
        });
        if (!items.length) list.innerHTML = '<div class="coord" style="text-align:center;">No hay resultados con ese filtro.</div>';
      }

      function pl_open() {
        const panel = document.getElementById('panel-licencias');
        panel.style.transform = 'translateX(0)';
        panel.setAttribute('aria-hidden','false');
        setTimeout(()=>document.getElementById('pl-search').focus({preventScroll:true}),50);
      }
      function pl_close() {
        const panel = document.getElementById('panel-licencias');
        panel.style.transform = 'translateX(100%)';
        panel.setAttribute('aria-hidden','true');
        document.getElementById('pl-detail').style.display = 'none';
      }
      function pl_openDetail(id) {
        const it = LICENSES_LITE.find(x => x.id === id);
        if (!it) return;
        const detail = document.getElementById('pl-detail');
        const req = it.requisitos || [];
        const mods = it.modalidades || [];
        detail.innerHTML = `
          <div style="display:flex; gap:8px; align-items:flex-start;">
            <div style="flex:1;">
              <div style="font-weight:700;">${it.nombre}</div>
              <div style="color:var(--muted); font-size:.92rem; margin-top:4px;">${it.descripcion}</div>
              ${mods.length ? '<div style="margin-top:8px; display:flex; gap:6px; flex-wrap:wrap;">' + mods.map(m => '<span class="pl-badge">'+m.nombre+'</span>').join(' ') + '</div>' : ''}
            </div>
            <button class="btn" onclick="document.getElementById('pl-detail').style.display='none'">‚úñ</button>
          </div>
          <div style="margin-top:10px;">
            <div class="badge">Requisitos generales</div>
            <ul style="margin-top:6px;" class="text-sm">
              ${req.map(r => '<li style="margin:4px 0; list-style:disc; margin-left:18px;">'+r+'</li>').join('')}
            </ul>
            ${mods.length ? '<div style="margin-top:10px;" class="badge">Requisitos adicionales por modalidad</div>' : ''}
            ${mods.map(m => `
              <div style="margin-top:8px;">
                <div style="font-weight:600; font-size:.95rem;">${m.nombre}</div>
                <ul style="margin-top:4px;">
                  ${((it.requisitosPorModalidad||{})[m.id]||['(Sin requisitos adicionales ‚Äî revisar norma)']).map(rr => '<li style="margin:4px 0; list-style:disc; margin-left:18px;">'+rr+'</li>').join('')}
                </ul>
              </div>`).join('')}
          </div>
        `;
        detail.style.display = 'block';
      }
      document.addEventListener('click', (e) => { if (e.target && e.target.id === 'btn-licencias') pl_open(); });
      document.addEventListener('keydown', (e) => { if (e.key === 'Escape') pl_close(); });
      const _plc = document.getElementById('pl-close'); if (_plc) _plc.addEventListener('click', pl_close);
      const plSearch = document.getElementById('pl-search');
      plSearch.addEventListener('input', () => {
        const q = plSearch.value.trim().toLowerCase();
        const items = LICENSES_LITE.filter(l =>
          [l.nombre, l.descripcion, ...(l.modalidades||[]).map(m => m.nombre)]
            .join(' ').toLowerCase().includes(q)
        );
        pl_renderList(items);
      });
      pl_renderList(LICENSES_LITE);

      // === MAPA 3D ===
      const map3d = $('#map3d');
      let glmap = null;
      let is3D = false;
      const terrainDEM = {
        type: 'raster-dem',
        tiles: ['https://s3.amazonaws.com/elevation-tiles-prod/terrarium/{z}/{x}/{y}.png'],
        tileSize: 256,
        encoding: 'terrarium'
      };
      const maplibreSourceDefs = {
        osm: { type: 'raster', tiles: ['https://a.tile.openstreetmap.org/{z}/{x}/{y}.png', 'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png', 'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 },
        hot: { type: 'raster', tiles: ['https://a.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', 'https://b.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png', 'https://c.tile.openstreetmap.fr/hot/{z}/{x}/{y}.png'], tileSize: 256 },
        opentopo: { type: 'raster', tiles: ['https://a.tile.opentopomap.org/{z}/{x}/{y}.png', 'https://b.tile.opentopomap.org/{z}/{x}/{y}.png', 'https://c.tile.opentopomap.org/{z}/{x}/{y}.png'], tileSize: 256 },
        sentinel2: { type: 'raster', tiles: ['https://tiles.maps.eox.at/wmts?layer=s2cloudless-2024&style=default&tilematrixset=WebMercatorQuad&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image%2Fjpeg&TileMatrix={z}&TileCol={x}&TileRow={y}'], tileSize: 256 },
        esri: { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256 },
        none: { type: 'raster', tiles: [], tileSize: 256 }
      };
      function ensure3D() {
        if (glmap) return;
        const c = map.getCenter(), z = map.getZoom();
        glmap = new maplibregl.Map({
          container: 'map3d',
          style: { version: 8, sources: { terrainRGB: terrainDEM }, layers: [] },
          center: [c.lng, c.lat],
          zoom: z,
          pitch: 55,
          bearing: 0,
          antialias: true
        });
        glmap.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), 'bottom-right');
        glmap.addControl(new maplibregl.ScaleControl({}), 'bottom-left');
        glmap.on('load', () => {
          glmap.setTerrain({ source: 'terrainRGB', exaggeration: 1.1 });
          document.dispatchEvent(new Event('glmap-ready'));
        });
        glmap.on('move', () => {
          const c = glmap.getCenter();
          hud.textContent = `‚õ∞Ô∏è 3D ‚Äî lat: ${c.lat.toFixed(5)}, lng: ${c.lng.toFixed(5)}, z: ${glmap.getZoom().toFixed(2)}, brg: ${Math.round((glmap.getBearing() % 360 + 360) % 360)}, pitch: ${Math.round(glmap.getPitch())}`;
        });
      }
      function change3DBasemap(key) {
        if (!glmap || !glmap.getStyle()) return;
        try {
          if (glmap.getLayer('baser')) glmap.removeLayer('baser');
          if (glmap.getSource('basesrc')) glmap.removeSource('basesrc');
          if (key !== 'none') {
            glmap.addSource('basesrc', maplibreSourceDefs[key]);
            glmap.addLayer({ id: 'baser', type: 'raster', source: 'basesrc' });
          }
        } catch (e) { console.error(e); }
      }
      function show2D() {
        $('#map').style.display = 'block';
        map3d.style.display = 'none';
        is3D = false;
        $('#btn2d').classList.add('active');
        $('#btn3d').classList.remove('active');
        $('#tbbox').style.display = 'none';
        setTimeout(() => map.invalidateSize(), 250);
        syncHUD2D();
      }
      function show3D() {
        ensure3D();
        const c = map.getCenter(), z = map.getZoom();
        const apply = () => {
          change3DBasemap(currentBase);
          glmap.jumpTo({ center: [c.lng, c.lat], zoom: z, pitch: 55 });
        };
        if (glmap.isStyleLoaded()) apply(); else glmap.once('load', apply);
        $('#map').style.display = 'none';
        map3d.style.display = 'block';
        is3D = true;
        $('#btn2d').classList.remove('active');
        $('#btn3d').classList.add('active');
        $('#tbbox').style.display = 'block';
        setTimeout(() => glmap.resize(), 250);
      }
      $('#btn2d').addEventListener('click', show2D);
      $('#btn3d').addEventListener('click', show3D);
      $('#btn-reset').addEventListener('click', () => {
        map.flyTo(start, 12, { duration: 1.0 });
        if (glmap) {
          glmap.easeTo({ center: [start[1], start[0]], zoom: 12, pitch: 55, bearing: 0, duration: 800 });
        }
      });
      // Trackball, drawer, tabs, dropdowns...
      const tb = $('#tb');
      const tbc = tb.getContext('2d');
      let tbActive = false, lastX = 0, lastY = 0;
      function clamp(v, min, max) { return Math.max(min, Math.min(max, v)); }
      function wrap360(v) { return (v % 360 + 360) % 360; }
      function drawTB() {
        const w = tb.width, h = tb.height, r = w / 2;
        tbc.clearRect(0, 0, w, h);
        tbc.save();
        tbc.translate(r, r);
        const bearing = glmap ? glmap.getBearing() : 0;
        const pitch = glmap ? glmap.getPitch() : 55;
        tbc.strokeStyle = 'rgba(21,62,117,.45)';
        tbc.lineWidth = 1.5;
        tbc.beginPath(); tbc.arc(0, 0, r - 3, 0, Math.PI * 2); tbc.stroke();
        tbc.beginPath(); tbc.ellipse(0, 0, r - 10, (r - 10) * Math.cos(pitch * Math.PI / 180), 0, 0, Math.PI * 2); tbc.stroke();
        tbc.rotate(-bearing * Math.PI / 180);
        tbc.beginPath(); tbc.ellipse(0, 0, (r - 10) * Math.cos(pitch * Math.PI / 180), r - 10, 0, 0, Math.PI * 2); tbc.stroke();
        tbc.fillStyle = 'rgba(10,132,255,.9)';
        tbc.beginPath(); tbc.arc(0, -(r - 12), 4, 0, Math.PI * 2); tbc.fill();
        tbc.restore();
      }
      function setBearingPitch(b, p) {
        if (!glmap) return;
        glmap.easeTo({ bearing: wrap360(b), pitch: clamp(p, 0, 80), duration: 0 });
        drawTB();
      }
      tb.addEventListener('pointerdown', e => {
        if (!is3D || !glmap) return;
        tbActive = true;
        const r = tb.getBoundingClientRect();
        lastX = e.clientX - r.left;
        lastY = e.clientY - r.top;
        tb.setPointerCapture(e.pointerId || 1);
      });
      tb.addEventListener('pointermove', e => {
        if (!tbActive || !glmap) return;
        const r = tb.getBoundingClientRect();
        const x = e.clientX - r.left, y = e.clientY - r.top;
        const dx = x - lastX, dy = y - lastY;
        lastX = x; lastY = y;
        setBearingPitch(glmap.getBearing() + (dx * 180 / 120), glmap.getPitch() - (dy * 90 / 120));
      });
      window.addEventListener('pointerup', () => tbActive = false);
      $('#tb-north').addEventListener('click', () => setBearingPitch(0, glmap ? glmap.getPitch() : 55));
      $('#tb-reset').addEventListener('click', () => {
        if (!glmap) return;
        const c = glmap.getCenter();
        glmap.easeTo({ center: [c.lng, c.lat], bearing: 0, pitch: 55, duration: 250 });
        drawTB();
      });
      document.addEventListener('glmap-ready', () => glmap.on('move', drawTB));
      $('#open-drawer').addEventListener('click', () => $('#drawer').classList.add('open'));
      $('#close-drawer').addEventListener('click', () => $('#drawer').classList.remove('open'));
      $$('.tab').forEach(tab => tab.addEventListener('click', () => {
        const target = tab.dataset.tab;
        $$('.tab').forEach(t => t.classList.remove('active'));
        $$('.panel').forEach(p => p.classList.remove('active'));
        tab.classList.add('active');
        $(`#panel-${target}`).classList.add('active');
      }));
      function closeAllDropdowns() {
        document.querySelectorAll('.dropdown').forEach(dropdown => {
          dropdown.classList.remove('active');
        });
      }
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.dropdown')) {
          closeAllDropdowns();
        }
      });
      document.getElementById('urbanismo-dropdown').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('planes-dropdown').classList.remove('active');
        document.getElementById('urbanismo-dropdown').classList.toggle('active');
      });
      document.getElementById('planes-dropdown').addEventListener('click', (e) => {
        e.stopPropagation();
        document.getElementById('urbanismo-dropdown').classList.remove('active');
        document.getElementById('planes-dropdown').classList.toggle('active');
      });
      $$('[id="planes-dropdown"] .dropdown-content a').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const texto = a.textContent.trim();
          if (municipiosNombres[texto]) {
            cargarCapasMunicipio(texto);
          }
        });
      });

      /* === CARGA, VISUALIZACI√ìN Y EDICI√ìN DE GEOJSON === */
      const gjList = $('#geojson-list');
      const fileInput = $('#file-geojson');
      const dropzone = $('#dz-geojson');
      const btnExportAll = $('#export-all-geojson');
      const btnClearAll = $('#clear-all-geojson');
      const geoLayers = new Map();
      let gjAutoId = 1;

      function randomColor() {
        const palette = ['#2563eb','#d32f2f','#2aa843','#7c3aed','#e67e22','#16a085','#8e44ad','#2c3e50'];
        return palette[(geoLayers.size) % palette.length];
      }
      function buildStyle(color, opacity) {
        return {
          color,
          weight: 2,
          opacity,
          fillColor: color,
          fillOpacity: Math.min(opacity, 0.5)
        };
      }
      function applyOpacityToGroup(group, opacity) {
        group.setStyle?.(l => buildStyle(l.options.color || '#2563eb', opacity));
        group.eachLayer(l => {
          if (l.setStyle) l.setStyle(buildStyle((l.options.color||'#2563eb'), opacity));
          if (l.setOpacity) l.setOpacity(opacity);
        });
      }
      function toSingleFeatureCollection(group) {
        const gj = group.toGeoJSON();
        return gj.type === 'FeatureCollection' ? gj : { type: 'FeatureCollection', features: [gj] };
      }
      function pointToLayerFactory(color) {
        return (feature, latlng) => L.circleMarker(latlng, {
          radius: 6,
          color,
          weight: 2,
          fillColor: color,
          fillOpacity: 0.5
        });
      }
      function onEachFeatureFactory() {
        return (f, layer) => {
          if (f && f.properties) {
            const rows = Object.entries(f.properties)
              .map(([k,v]) => `<tr><td><b>${k}</b></td><td>${v}</td></tr>`).join('');
            const pid = crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2);
            const html = `
              <div style="min-width:220px">
                <b>Propiedades</b>
                <table style="font-size:.9em">${rows || '<tr><td colspan="2"><i>sin atributos</i></td></tr>'}</table>
                <button class="mini" data-edit="${pid}">‚úèÔ∏è Editar propiedades</button>
              </div>`;
            layer.bindPopup(html);
            layer.on('popupopen', (e) => {
              const btn = e.popup.getElement().querySelector(`[data-edit="${pid}"]`);
              if (!btn) return;
              btn.addEventListener('click', () => {
                const current = JSON.stringify(f.properties || {}, null, 2);
                const next = prompt('Edita el JSON de propiedades (usa sintaxis v√°lida):', current);
                if (!next) return;
                try {
                  const parsed = JSON.parse(next);
                  f.properties = parsed;
                  layer.closePopup();
                  onEachFeatureFactory()(f, layer);
                  layer.openPopup();
                } catch(err) {
                  alert('JSON inv√°lido. No se guardaron cambios.');
                }
              }, { once: true });
            });
          }
        };
      }
      function addGeoJSONToMap(name, data, options={}) {
        const id = `gj-${gjAutoId++}`;
        const color = options.color || randomColor();
        const opacity = options.opacity ?? 0.8;
        const group = L.geoJSON(data, {
          style: buildStyle(color, opacity),
          pointToLayer: pointToLayerFactory(color),
          onEachFeature: onEachFeatureFactory()
        }).addTo(map);
        group.eachLayer(l => { if (l.pm) l.pm.setOptions?.({ snappable: true, snapDistance: 15, allowSelfIntersection: true, allowCutting: false }); });
        geoLayers.set(id, { group, name, color, opacity, visible: true });
        capasFeatures[id] = data.features;
        const li = document.createElement('div');
        li.className = 'gj-item';
        li.id = `item-${id}`;
        li.innerHTML = `
          <div>
            <div class="title">${name}</div>
            <div style="color:var(--muted); font-size:.85rem">${id}</div>
          </div>
          <div class="gj-controls">
            <label class="elegant-toggle" title="Mostrar/ocultar">
              <input type="checkbox" checked data-vis="${id}">
              <span class="slider"></span>
            </label>
            <input type="range" min="0" max="1" step="0.05" value="${opacity}" class="range-mini" data-op="${id}" title="Opacidad">
            <input type="color" value="${color}" class="mini" data-color="${id}" title="Color">
            <button class="mini" data-edit="${id}" title="Activar/Desactivar edici√≥n">‚úèÔ∏è Editar</button>
            <button class="mini" data-zoom="${id}" title="Zoom a capa">üîé</button>
            <button class="mini" data-menu="${id}" title="M√°s opciones">‚ãØ</button>
            <button class="mini" data-exp="${id}" title="Exportar GeoJSON">‚¨áÔ∏è</button>
            <button class="mini" data-del="${id}" title="Quitar del mapa">üóëÔ∏è</button>
          </div>
        `;
        gjList.prepend(li);
        const menuBtn = li.querySelector(`[data-menu="${id}"]`);
        if (menuBtn) crearMenuContextual(menuBtn, id, data.features, name);
        li.querySelector(`[data-vis="${id}"]`).addEventListener('change', (e) => {
          const meta = geoLayers.get(id); if (!meta) return;
          meta.visible = e.target.checked;
          if (meta.visible) meta.group.addTo(map); else map.removeLayer(meta.group);
        });
        li.querySelector(`[data-op="${id}"]`).addEventListener('input', (e) => {
          const meta = geoLayers.get(id); if (!meta) return;
          meta.opacity = parseFloat(e.target.value);
          applyOpacityToGroup(meta.group, meta.opacity);
        });
        li.querySelector(`[data-color="${id}"]`).addEventListener('input', (e) => {
          const meta = geoLayers.get(id); if (!meta) return;
          meta.color = e.target.value;
          meta.group.setStyle?.({ color: meta.color, fillColor: meta.color });
          meta.group.eachLayer(l => { if (l.setStyle) l.setStyle({ color: meta.color, fillColor: meta.color }); });
        });
        let editing = false;
        li.querySelector(`[data-edit="${id}"]`).addEventListener('click', (e) => {
          const meta = geoLayers.get(id); if (!meta) return;
          editing = !editing;
          e.currentTarget.textContent = editing ? '‚úÖ Editando' : '‚úèÔ∏è Editar';
          meta.group.eachLayer(l => { if (!l.pm) return; if (editing) l.pm.enable(); else l.pm.disable(); });
        });
        li.querySelector(`[data-zoom="${id}"]`).addEventListener('click', () => {
          try { map.fitBounds(group.getBounds(), { maxZoom: 17, padding: [20,20] }); }
          catch(e){ /* puede no tener bounds */ }
        });
        li.querySelector(`[data-exp="${id}"]`).addEventListener('click', () => {
          const fc = toSingleFeatureCollection(group);
          const safe = name.replace(/[^\w\-]+/g, '_').slice(0,50) || 'capa';
          downloadJSON(fc, `${safe}.geojson`);
        });
        li.querySelector(`[data-del="${id}"]`).addEventListener('click', () => {
          map.removeLayer(group);
          geoLayers.delete(id);
          delete capasFeatures[id];
          li.remove();
        });
      }
      async function handleFiles(fileList) {
        const files = Array.from(fileList).filter(f => /(\.geojson|\.json)$/i.test(f.name));
        if (!files.length) { alert('No se detectaron archivos .geojson o .json'); return; }
        loading.classList.add('active');
        for (const f of files) {
          try {
            const txt = await f.text();
            const data = JSON.parse(txt);
            addGeoJSONToMap(f.name.replace(/\.(geojson|json)$/i,''), data);
          } catch (err) {
            console.error('Error leyendo', f.name, err);
            alert(`No se pudo cargar: ${f.name}`);
          }
        }
        loading.classList.remove('active');
      }
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));
      ;[dropzone, document.getElementById('map')].forEach(el => {
        el.addEventListener('dragover', (ev) => { ev.preventDefault(); dropzone.classList.add('dragover'); });
        el.addEventListener('dragleave', () => dropzone.classList.remove('dragover'));
        el.addEventListener('drop', (ev) => {
          ev.preventDefault(); dropzone.classList.remove('dragover');
          const dt = ev.dataTransfer; if (!dt) return;
          handleFiles(dt.files);
        });
      });
      btnExportAll.addEventListener('click', () => {
        if (geoLayers.size === 0) { alert('No hay capas para exportar.'); return; }
        const all = [];
        geoLayers.forEach(({group}) => {
          const fc = toSingleFeatureCollection(group);
          all.push(...fc.features);
        });
        downloadJSON({ type: 'FeatureCollection', features: all }, 'todas_las_capas.geojson');
      });
      btnClearAll.addEventListener('click', () => {
        if (!geoLayers.size) return;
        if (!confirm('¬øQuitar todas las capas GeoJSON del mapa?')) return;
        geoLayers.forEach(({group}) => map.removeLayer(group));
        geoLayers.clear();
        gjList.innerHTML = '';
        Object.keys(capasFeatures).forEach(k => delete capasFeatures[k]);
      });
      loading.classList.remove('active');
    });
  </script>

  <aside id="panel-licencias" style="
    position: fixed;
    top: var(--headerH);
    right: 0;
    height: calc(100% - var(--headerH));
    width: min(440px, 100%);
    background: #fff;
    border-left: 1px solid var(--border);
    box-shadow: var(--shadow);
    transform: translateX(100%);
    transition: transform .3s ease;
    z-index: 4000;
    display: flex;
    flex-direction: column;
  " aria-hidden="true">
    <div style="padding:12px 14px; border-bottom: 1px solid var(--border); display:flex; align-items:center; gap:8px;">
      <div style="font-weight:700; font-size: 1.05rem; display:flex; align-items:center; gap:8px;">üìù Licencias urban√≠sticas</div>
      <button id="pl-close" class="btn" style="margin-left:auto;">‚úñ</button>
    </div>
    <div style="padding:10px 14px; border-bottom: 1px solid var(--border); display:flex; gap:8px; align-items:center;">
      <span>üîç</span>
      <input id="pl-search" class="input" placeholder="Buscar por nombre o modalidad‚Ä¶" />
    </div>
    <div style="flex:1; display:grid; grid-template-rows: 1fr auto;">
      <div id="pl-list" style="overflow:auto; padding:12px 14px; display:grid; gap:10px;"></div>
      <div id="pl-detail" style="border-top:1px solid var(--border); background:#fff; padding:12px 14px; max-height: 45vh; overflow:auto; display:none;"></div>
    </div>
    <div style="padding:10px 14px; font-size:11px; color:var(--muted); border-top:1px solid var(--border);">
      ‚ö†Ô∏è Referencial. Ver Decreto 1077/2015, FUN vigente y normativa local POT/EOT.
    </div>
  </aside>

</body>
</html>
